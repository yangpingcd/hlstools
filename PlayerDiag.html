<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>HLS Player Diagnostics</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" type="text/css" href="lib/bootstrap/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="PlayerDiag.css">

    <script src="lib/jquery/jquery.js"></script>
    <script src="lib/bootstrap/bootstrap.js"></script>
    <script src="PlayerDiagSetting.js"></script>

    <script>
        // http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
        function getURLParameter(sParam) {
            var sPageURL = decodeURIComponent(window.location.search.substring(1));
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        }
    </script>

    <script>
        "use strict";

        const STATS_TYPE_PLAYLIST = 'playlist';
        const STATS_TYPE_CHUNKLIST = 'chunklist';
        const STATS_TYPE_CHUNK = 'chunk';

        class StatsItem {
            constructor(statsType, startTime, url) {
                this.statsType = statsType;
                this.startTime = startTime;
                this.url = url;

                this.timeout = false;
                this.error = false;
                this.statusCode = 0;
                this.size = 0;
                this.responseTime = 0;
            }

            update(xhr) {
                this.statusCode = xhr.status;
                if (xhr.response && xhr.response.length)
                    this.size = xhr.response.length;

                let endTime = (new Date()).getTime();
                this.responseTime = endTime - this.startTime;
                if (this.responseTime < 0)
                    this.responseTime = 0;
            }
        }

        class Stats {
            constructor() {
                // array of StatsItem
                this.statsItems = [];

                // event
                this.onchanged = null;
            }

            clearStatsItems() {
                this.statsItems = [];
                if (this.onchanged) {
                    this.onchanged();
                }
            }

            addStats(item) {
                this.statsItems.push(item);
                while (this.statsItems.length > 10000) {
                    this.statsItems.shift();
                }

                if (this.onchanged) {
                    this.onchanged(item.statsType);
                }
            }

            getTypedStatsItems(statsType, cond) {
                if (!statsType && !cond)
                    return this.statsItems;
                return this.statsItems.filter(item => (!statsType || item.statsType == statsType) && (!cond || cond(item)));
            }

            getTimeoutStatsItems(statsType) {
                return this.getTypedStatsItems(statsType, item => item.timeout);
            }

            getErrorStatsItems(statsType) {
                return this.getTypedStatsItems(statsType, item => item.error);
            }

            lastStatsItem(statsType) {
                let typedStatsItems = this.getTypedStatsItems(statsType);
                return typedStatsItems.length > 0 ? typedStatsItems[typedStatsItems.length - 1] : null;
            }

            lastURL(statsType) {
                let typedStatsItems = this.getTypedStatsItems(statsType);
                return typedStatsItems.length > 0 ? typedStatsItems[typedStatsItems.length - 1].url : '';
            }

            lastTimeoutStatsItem(statsType) {
                let timeoutItems = this.getTimeoutStatsItems(statsType);
                return timeoutItems.length > 0 ? timeoutItems[timeoutItems.length - 1] : null;
            }

            lastTimeoutURL(statsType) {
                let timeoutItems = this.getTimeoutStatsItems(statsType);
                return timeoutItems.length > 0 ? timeoutItems[timeoutItems.length - 1].url : '';
            }

            lastErrorStatsItem(statsType) {
                let errorItems = this.getErrorStatsItems(statsType);
                return errorItems.length > 0 ? errorItems[errorItems.length - 1] : null;
            }

            lastErrorURL(statsType) {
                let errorItems = this.getErrorStatsItems(statsType);
                return errorItems.length > 0 ? errorItems[errorItems.length - 1].url : '';
            }

            getStatusCodeHistogram(statsType) {
                let typedStatsItems = this.getTypedStatsItems(statsType);

                let statusCodes = {};

                typedStatsItems.forEach(item => {
                    let key = '' + item.statusCode; // convert to string
                    if (statusCodes[key]) {
                        statusCodes[key]++;
                    } else {
                        statusCodes[key] = 1;
                    }
                });

                let getSequential = function (cond) {
                    let count = 0;
                    let sequential = 0;
                    let curSequential = 0;

                    typedStatsItems.forEach(item => {
                        count += (cond && cond(item)) ? 1 : 0;
                        curSequential = (cond && cond(item)) ? curSequential + 1 : 0;
                        if (sequential < curSequential)
                            sequential = curSequential;
                    });

                    return [count, sequential];
                }

                let [timeout, sequentialTimeout] = getSequential(item => item.timeout);
                let [error, sequentialError] = getSequential(item => item.error);

                if (timeout > 0) {
                    statusCodes['Timeout'] = timeout;
                    statusCodes['Sequential Timeout'] = sequentialTimeout;
                }
                if (error > 0) {
                    statusCodes['Error'] = error;
                    statusCodes['Sequential Error'] = sequentialError;
                }

                return statusCodes;
            }

            getResponseTimeHisto(statsType) {
                let responseTimes = this.getResponseTimes(statsType);
                if (responseTimes.length <= 0) {
                    return [];
                }

                let ranges = [10, 100, 500, 1000, 2500, 5000, 10000];
                let responseTimeHisto = [
                    { key: "< 10ms", value: 0 },
                    { key: "10ms - 100ms", value: 0 },
                    { key: "100ms - 500ms", value: 0 },
                    { key: "500ms - 1s", value: 0 },
                    { key: "1s - 2.5s", value: 0 },
                    { key: "2.5s - 5s", value: 0 },
                    { key: "5s - 10s", value: 0 },
                    { key: "> 10s", value: 0 },
                ];

                responseTimes.forEach(value => {
                    for (let i = 0; i < ranges.length; i++) {
                        if (value < ranges[i]) {
                            responseTimeHisto[i].value++;
                            return;
                        }
                    }
                    // last
                    responseTimeHisto[responseTimeHisto.length - 1].count++;
                })

                if (true) {
                    responseTimeHisto.push({ key: 'Last (ms)', value: Stats.responseTimeLast(responseTimes) });
                    responseTimeHisto.push({ key: 'Min (ms)', value: Stats.responseTimeMin(responseTimes) });
                    responseTimeHisto.push({ key: 'Max (ms)', value: Stats.responseTimeMax(responseTimes) });
                    responseTimeHisto.push({ key: 'Avg (ms)', value: Stats.responseTimeAvg(responseTimes) });
                    responseTimeHisto.push({ key: 'Avg (Last 10) (ms)', value: Stats.responseTimeAvgLast10(responseTimes) });
                    responseTimeHisto.push({ key: 'Avg (Last 100) (ms)', value: Stats.responseTimeAvgLast100(responseTimes) });
                }

                return responseTimeHisto;
            }

            getStatusCodes(statsType) {
                let typedStatsItems = this.getTypedStatsItems(statsType);
                let statusCodes = typedStatsItems.map(item => item.statusCode);
                return statusCodes;
            }

            getResponseTimes(statsType) {
                let typedStatsItems = this.getTypedStatsItems(statsType);
                let responseTimes = typedStatsItems.map(item => item.responseTime);
                return responseTimes;
            }

            static responseTimeLast(responseTimes) {
                if (responseTimes.length <= 0)
                    return 0;
                return responseTimes[responseTimes.length - 1];
            }
            static responseTimeMin(responseTimes) {
                if (responseTimes.length <= 0)
                    return 0;
                return Math.min.apply(Math, responseTimes);
            }
            static responseTimeMax(responseTimes) {
                if (responseTimes.length <= 0)
                    return 0;
                return Math.max.apply(Math, responseTimes);
            }
            static responseTimeAvg(responseTimes) {
                if (responseTimes.length <= 0)
                    return 0;
                let sum = responseTimes.reduce((total, cur) => total + cur, 0);
                return Math.floor(sum / responseTimes.length);
            }
            static responseTimeAvgLast10(responseTimes) {
                if (responseTimes.length <= 0)
                    return 0;
                let last10 = responseTimes.slice(-10);
                let sum = last10.reduce((total, cur) => total + cur, 0);
                return Math.floor(sum / last10.length);
            }
            static responseTimeAvgLast100(responseTimes) {
                if (responseTimes.length <= 0)
                    return 0;
                let last100 = responseTimes.slice(-100);
                let sum = last100.reduce((total, cur) => total + cur, 0);
                return Math.floor(sum / last100.length);
            }
        }

        var statsManager = {
            startTime: 0,
            lastStartTime: 0,
            ipAddress: '',
            userAgent: '',
            reportTemplate: '',

            stats: new Stats(),
            timeout: 20000,
            playing: false,
            lastChunk: void 0, // undefined
        };

    </script>

    <script>
        "use strict";
        function requestStream(statsType, url, callback) {
            let startTime = (new Date()).getTime();
            let statsItem = new StatsItem(statsType, startTime, url);

            let xhr = new XMLHttpRequest();
            /*xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    statsItem.update(xhr);
                    statsManager.stats.addStats(statsItem);                    
                }
            };*/
            xhr.ontimeout = function (evt) {
                statsItem.timeout = true;
            }
            xhr.onerror = function () {
                statsItem.error = true;
            }
            xhr.onloadend = function (evt) {
                statsItem.update(xhr);
                statsManager.stats.addStats(statsItem);

                if (callback) {
                    callback(xhr);
                }
            }

            xhr.open("GET", url, true);
            xhr.timeout = statsManager.timeout;
            xhr.send();
        }

        function requestChunk(url) {
            requestStream(STATS_TYPE_CHUNK, url, function (xhr) {

            });
        }

        function requestChunklist(url) {
            requestStream(STATS_TYPE_CHUNKLIST, url, function (xhr) {
                if (xhr.status >= 200 && xhr.status < 400) {
                    let chunks = [];

                    let myRegexp = /#EXTINF.*\r?\n(.*)/g;
                    let m = myRegexp.exec(xhr.responseText);
                    while (m) {
                        if (m[1] && m[1].indexOf("#") == -1) { // not empty and not starts with #
                            chunks.push(m[1]);
                        }
                        m = myRegexp.exec(xhr.responseText);
                    }

                    if (chunks.length > 0) {
                        let lastChunkIndex = chunks.indexOf(statsManager.lastChunk);

                        let playingChunk;
                        if (lastChunkIndex >= 0 && lastChunkIndex < chunks.length - 1) {
                            playingChunk = chunks[lastChunkIndex + 1];
                        } else {
                            playingChunk = chunks[chunks.length - 1];
                        }

                        if (playingChunk != statsManager.lastChunk) {
                            statsManager.lastChunk = playingChunk;

                            let pos = url.lastIndexOf("/");
                            let chunkUrl = url.substring(0, pos + 1) + statsManager.lastChunk;
                            if (statsManager.playing) {
                                requestChunk(chunkUrl);
                            }
                        }
                    }
                }

                if (statsManager.playing) {
                    setTimeout(requestChunklist, 8000, url);
                }
            });
        }

        function requestPlaylist(url) {
            requestStream(STATS_TYPE_PLAYLIST, url, function (xhr) {
                let hasChunklist = false;
                if (xhr.status >= 200 && xhr.status < 400) {
                    let myRegexp = /#EXT-X-STREAM-INF.*\r?\n(.*)/;
                    let m = myRegexp.exec(xhr.responseText);
                    if (m && m[1]) {
                        let pos = url.lastIndexOf("/");
                        let chunklistUrl = (pos > 0 ? url.substring(0, pos + 1) + m[1] : m[1]);
                        if (statsManager.playing) {
                            requestChunklist(chunklistUrl);
                        }
                        hasChunklist = true;
                    }
                }

                if (statsManager.playing && !hasChunklist) {
                    setTimeout(requestPlaylist, 10000, url);
                }
            });
        }

        function fillStatsManager() {
            // If your site is on Cloudflare, then you can use '/cdn-cgi/trace' instead
            $.get('https://www.cloudflare.com/cdn-cgi/trace', function (data) {
                //console.log(data)
                let lines = ('' + data).split(/\r*?\n/g);
                lines.forEach(line => {
                    if (line.startsWith('ip='))
                        statsManager.ipAddress = line.substr(3);
                    else if (line.startsWith('uag='))
                        statsManager.userAgent = line.substr(4);
                })
            })

            try {
                $.get('PlayerDiagReport.html', function (data) {
                    statsManager.reportTemplate = '' + data;
                });
            } catch (err) {

            }

            let timeout = parseInt(getURLParameter('timeout'));
            if (!isNaN(timeout)) {
                statsManager.timeout = timeout;
            }

            statsManager.stats.onchanged = stats_onchanged;
        }

        $(window).on('load', function () {
            fillStatsManager();

            let streamUrl = getURLParameter('streamurl')
            if (streamUrl) {
                $('#streamURLSelect').append($('<option></option>').val(streamUrl).text(streamUrl).attr('selected', true));
                $('#streamURLSelect').prop('disabled', true);
            } else {
                setting.streamURLs.forEach(item => {
                    $('#streamURLSelect').append($('<option></option>').val(item).text(item));
                });
            }

            loadSettings();
            chkStats_onchange();

            clearStats();
            setInterval(myTimer, 1000);
        });

        $(window).on('unload', function () {
            saveSettings();
        })

        function saveSettings() {
            //console.log('saveSettings');
            let saveValue = function (name, id) {
                if (!$('#' + id).prop('disabled')) {
                    localStorage.setItem(name, $('#' + id).val());
                }
            };
            let saveCheck = function (name, id) {
                localStorage.setItem(name, $('#' + id).prop('checked'));
            };

            try {
                saveValue('userid', 'userID');
                saveValue('isp', 'isp');
                saveValue('streamUrl', 'streamURLSelect');

                saveCheck('autoUpload', 'autoUpload');

                saveCheck('showStatusCodeStats', 'chkStatusCodeStats');
                saveCheck('showResponseTimeStats', 'chkResponseTimeStats');
                saveCheck('showOverallStats', 'chkOverallStats');
                saveCheck('showPlaylistStats', 'chkPlaylistStats');
                saveCheck('showChunklistStats', 'chkChunklistStats');
                saveCheck('showChunkStats', 'chkChunkStats');
            } catch {

            }
        }

        function loadSettings() {
            let loadValue = function (name, id) {
                let value = localStorage.getItem(name);
                if (value)
                    $('#' + id).val(value);
            };
            let loadOption = function (name, id) {
                let value = localStorage.getItem(name);
                if (value)
                    $('#' + id).find(`option[value="${value}"`).attr('selected', true);
            };
            let loadCheck = function (name, id) {
                let value = localStorage.getItem(name);
                if (value === 'true')
                    $('#' + id).prop('checked', true);
                else if (value === 'false')
                    $('#' + id).prop('checked', false);
            };

            try {
                loadValue("userid", 'userID');
                loadValue('isp', 'isp');
                loadOption('streamUrl', 'streamURLSelect');

                loadCheck('autoUpload', 'autoUpload');

                loadCheck('showStatusCodeStats', 'chkStatusCodeStats');
                loadCheck('showResponseTimeStats', 'chkResponseTimeStats');
                loadCheck('showOverallStats', 'chkOverallStats');
                loadCheck('showPlaylistStats', 'chkPlaylistStats');
                loadCheck('showChunklistStats', 'chkChunklistStats');
                loadCheck('showChunkStats', 'chkChunkStats');
            } catch {

            }
        }

        function chkStats_onchange() {
            let showStats = function (chkId1, chkId2, divId) {
                if ($('#' + chkId1).prop('checked') && $('#' + chkId2).prop('checked')) {
                    $('#' + divId).removeClass('d-none').addClass('d-block');
                } else {
                    $('#' + divId).removeClass('d-block').addClass('d-none');
                }
            }

            showStats('chkStatusCodeStats', 'chkOverallStats', 'divStatusCodeStats');
            showStats('chkResponseTimeStats', 'chkOverallStats', 'divResponseTimeStats');
            showStats('chkStatusCodeStats', 'chkPlaylistStats', 'divStatusCodeStats_Playlist');
            showStats('chkResponseTimeStats', 'chkPlaylistStats', 'divResponseTimeStats_Playlist');
            showStats('chkStatusCodeStats', 'chkChunklistStats', 'divStatusCodeStats_Chunklist');
            showStats('chkResponseTimeStats', 'chkChunklistStats', 'divResponseTimeStats_Chunklist');
            showStats('chkStatusCodeStats', 'chkChunkStats', 'divStatusCodeStats_Chunk');
            showStats('chkResponseTimeStats', 'chkChunkStats', 'divResponseTimeStats_Chunk');

            showStats('chkPlaylistStats', 'chkPlaylistStats', 'divPlaylistStats');
            showStats('chkChunklistStats', 'chkChunklistStats', 'divChunklistStats');
            showStats('chkChunkStats', 'chkChunkStats', 'divChunkStats');

        }

        var lastUploadTime = 0;
        function myTimer() {
            saveSettings();

            if (statsManager.playing) {
                let nowTime = new Date().getTime();
                let elapsed = nowTime - statsManager.lastStartTime;
                $('#lblStartInfo').text('Testing in progress ' + formatDuration(elapsed));
            } else {
                $('#lblStartInfo').text('');
            }

            if (statsManager.playing && $('#autoUpload').prop('checked')) {
                let timeAlign = 5 * 60 * 1000; // 5 minutes

                if (lastUploadTime < statsManager.lastStartTime)
                    lastUploadTime = statsManager.lastStartTime;
                let nextUploadTime = Math.ceil(lastUploadTime / timeAlign) * timeAlign + timeAlign;

                let nowTime = new Date().getTime();
                if (nowTime > nextUploadTime) {
                    btnUploadNow_onclick();
                    lastUploadTime = nextUploadTime;
                }
            }

        }

        function getStreamUrl() {
            let streamUrl = getURLParameter('streamurl') || $('#streamURLSelect').val();

            if (streamUrl === 'Random') {
                let index = Math.floor(Math.random() * setting.streamURLs.length);
                streamUrl = setting.streamURLs[index];
            }
            streamUrl = streamUrl || 'http://sg002-live.sliq.net/00309-live/matrix1/Playlist.m3u8';

            return streamUrl;
        }

        function getSASUri() {
            let sasUri = getURLParameter('sasuri') || '' + setting.sasURI;
            if (!sasUri.startsWith("http")) {
                sasUri = window.atob(sasUri);
            }
            return sasUri;
        }

        function btnStart_onclick() {
            saveSettings();

            let btnStart = $('#btnStart');

            if (btnStart.text() == 'Start') {
                btnStart.text('Stop');
                statsManager.playing = true;

                let nowTime = new Date().getTime();
                if (statsManager.startTime == 0)
                    statsManager.startTime = nowTime;
                statsManager.lastStartTime = nowTime;

                let streamUrl = getStreamUrl();
                console.log('testing ' + streamUrl);

                requestPlaylist(streamUrl);
            } else {
                // todo: stop                
                btnStart.text('Start');
                statsManager.playing = false;

                btnUploadNow_onclick();
            }
        }

    </script>

    <script>
        "use strict";

        function stats_onchanged(statsType) {
            if (statsType) {
                displayStatusCodeStats(statsType);
                displayStatusCodeStats();
            } else {
                displayStatusCodeStats(STATS_TYPE_PLAYLIST);
                displayStatusCodeStats(STATS_TYPE_CHUNKLIST);
                displayStatusCodeStats(STATS_TYPE_CHUNK);
                displayStatusCodeStats();
            }

            if (statsType) {
                displayResponseTimeStats(statsType);
                displayResponseTimeStats();
            } else {
                displayResponseTimeStats(STATS_TYPE_PLAYLIST);
                displayResponseTimeStats(STATS_TYPE_CHUNKLIST);
                displayResponseTimeStats(STATS_TYPE_CHUNK);
                displayResponseTimeStats();
            }

            if (statsType) {
                displayResult(statsType);
            } else {
                displayResult(STATS_TYPE_PLAYLIST);
                displayResult(STATS_TYPE_CHUNKLIST);
                displayResult(STATS_TYPE_CHUNK);
            }
        }

        function displayResult(statsType) {
            let tbody = null;
            switch (statsType) {
                case STATS_TYPE_PLAYLIST:
                    tbody = $('#tabPlaylistStats tbody'); break;
                case STATS_TYPE_CHUNKLIST:
                    tbody = $('#tabChunklistStats tbody'); break;
                case STATS_TYPE_CHUNK:
                    tbody = $('#tabChunkStats tbody'); break;
                default:
                    return;
            }
            tbody.empty();

            let even = true;
            let addRow = function (name, value) {
                tbody.append(
                    $('<tr class="d-flex"></tr>')/*.addClass(even ? 'd0' : 'd1')*/.append([
                        $('<td class="col-6"></td>').text(name),
                        $('<td class="col-6"></td>').text(value)])
                );
                even = !even;
            }

            let stats = statsManager.stats;

            let last = stats.lastStatsItem(statsType);
            if (last) {
                addRow("Last URL", last.url);
            }
            let lastTimeout = stats.lastTimeoutStatsItem(statsType);
            if (lastTimeout) {
                addRow("Last Timeout URL", lastTimeout.url);
                addRow("Last Timeout happens", formatDateText(lastTimeout.startTime));
            }
            let lastError = stats.lastErrorStatsItem(statsType);
            if (lastError) {
                addRow("Last Error URL", lastError.url);
                addRow("Last Error happens", formatDateText(lastError.startTime));
            }

            let statusCodeHisto = stats.getStatusCodeHistogram(statsType);
            for (let key in statusCodeHisto) {
                let value = statusCodeHisto[key];
                addRow('StatusCode ' + key, value);
            }

            let responseTimeHisto = stats.getResponseTimeHisto(statsType);
            responseTimeHisto.forEach(item => {
                addRow('Response Time ' + item.key, item.value);
            });
        }

        function displayStatusCodeStats(statsType) {
            let tbody = null;
            switch (statsType) {
                case STATS_TYPE_PLAYLIST:
                    tbody = $('#tabStatusCodeStats_Playlist tbody'); break;
                case STATS_TYPE_CHUNKLIST:
                    tbody = $('#tabStatusCodeStats_Chunklist tbody'); break;
                case STATS_TYPE_CHUNK:
                    tbody = $('#tabStatusCodeStats_Chunk tbody'); break;
                default:
                    tbody = $('#tabStatusCodeStats tbody');
            }
            tbody.empty();

            let even = true;
            let addRow = function (name, value) {
                tbody.append(
                    $('<tr class="d-flex"></tr>')/*.addClass(even ? 'd0' : 'd1')*/.append([
                        $('<td class="col-6"></td>').text(name),
                        $('<td class="col-6"></td>').text(value)])
                );
                even = !even;
            }

            let statusCodeHisto = statsManager.stats.getStatusCodeHistogram(statsType);
            for (let key in statusCodeHisto) {
                let value = statusCodeHisto[key];
                addRow(key, value);
            }
        }


        function displayResponseTimeStats(statsType) {
            let tbody = null;
            switch (statsType) {
                case STATS_TYPE_PLAYLIST:
                    tbody = $('#tabResponseTimeStats_Playlist tbody'); break;
                case STATS_TYPE_CHUNKLIST:
                    tbody = $('#tabResponseTimeStats_Chunklist tbody'); break;
                case STATS_TYPE_CHUNK:
                    tbody = $('#tabResponseTimeStats_Chunk tbody'); break;
                default:
                    tbody = $('#tabResponseTimeStats tbody');
            }
            tbody.empty();

            let even = true;
            let addRow = function (name, value) {
                tbody.append(
                    $('<tr class="d-flex"></tr>')/*.addClass(even ? 'd0' : 'd1')*/.append(
                        '<td class="col-6">' + name + '</td>' +
                        '<td class="col-6">' + value + '</td>')
                );
                even = !even;
            }

            let responseTimeHisto = statsManager.stats.getResponseTimeHisto(statsType);
            responseTimeHisto.forEach(item => {
                addRow(item.key, item.value);
            });
        }

        function clearStats() {
            statsManager.startTime = statsManager.playing ? statsManager.startTime = (new Date()).getTime() : 0;
            statsManager.stats.clearStatsItems();

            statsManager.lastChunk = void 0; // lastChunk is undefined
        }

        function downloadCsv(csv, filename) {
            //var blob = new Blob([new Uint8Array(bArr)], { type: 'text/csv;charset=UTF-16LE;' });
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-16;' });

            if (navigator.msSaveBlob) {
                navigator.msSaveBlob(blob, filename);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) {
                    var url = window.URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }
            }
        }

        function formatDuration(duration, milliPart) {
            let secs = Math.floor(duration / 1000);
            let hours = Math.floor(secs / (60 * 60));

            let divisor_for_minutes = secs % (60 * 60);
            let minutes = Math.floor(divisor_for_minutes / 60);

            let divisor_for_seconds = divisor_for_minutes % 60;
            let seconds = Math.ceil(divisor_for_seconds);

            let str = '' + hours + ':' + ('0' + minutes).slice(-2) + ':' + ('0' + seconds).slice(-2);
            if (milliPart) str += '.' + ('00' + duration % 1000).slice(-3);
            return str;
        }

        function formatDate(d, timePart, milliPart) {
            if (typeof d === 'number') {
                d = new Date(d);
            }
            return d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2) +
                (timePart ? '_' + ('0' + d.getHours()).slice(-2) + ('0' + d.getMinutes()).slice(-2) + ('0' + d.getSeconds()).slice(-2) : '') +
                (milliPart ? '_' + ('00' + d.getMilliseconds()).slice(-3) : '');
        }

        function formatDateText(d, milliPart) {
            if (typeof d === 'number') {
                d = new Date(d);
            }
            return d.getFullYear() + '-' +
                ('0' + (d.getMonth() + 1)).slice(-2) + '-' +
                ('0' + d.getDate()).slice(-2) + ' ' +
                ('0' + d.getHours()).slice(-2) + ':' +
                ('0' + d.getMinutes()).slice(-2) + ':' +
                ('0' + d.getSeconds()).slice(-2) +
                (milliPart ? '.' + ('00' + d.getMilliseconds()).slice(-3) : '');
        }

        function escapeCSV(term) {
            let strTerm = '' + term; // convert to string
            if (strTerm.match(/,|"|\n/)) {
                let quoted = strTerm.replace(/"/g, '""');
                return '"' + quoted + '"';
            } else {
                return strTerm;
            }
        }

        function escapeFileName(fileName) {
            return fileName.replace(/[ ,\\\/:*?"<>|]/g, '_')
        }

        function getCsvHeader(headers) {
            let user = $('#userID').val().trim();
            let isp = $('#isp').val().trim();

            let line1 = [
                headers.join(),
                'user', 'isp', 'startTime', 'endTime', 'ipAddress', 'userAgent'
            ].join();

            let line2 = [
                ','.repeat(headers.length - 1),
                escapeCSV(user), escapeCSV(isp),
                statsManager.startTime == 0 ? '' : new Date(statsManager.startTime).toISOString(),
                statsManager.startTime == 0 ? '' : new Date().toISOString(),
                statsManager.ipAddress, escapeCSV(statsManager.userAgent)
            ].join();

            return [line1, line2];
        }

        function csvStatusCode() {
            let csvRows = getCsvHeader(['type', 'status', 'count']);

            let statsToCsvRows = function (statsType) {
                let rows = [];

                let statusCodeHisto = statsManager.stats.getStatusCodeHistogram(statsType);
                for (let key in statusCodeHisto) {
                    let value = statusCodeHisto[key];
                    rows.push([statsType, key, value].join());
                }
                return rows;
            }

            csvRows.push(...statsToCsvRows());
            csvRows.push(...statsToCsvRows(STATS_TYPE_PLAYLIST));
            csvRows.push(...statsToCsvRows(STATS_TYPE_CHUNKLIST));
            csvRows.push(...statsToCsvRows(STATS_TYPE_CHUNK));

            return csvRows.join('\n');
        }

        function csvResponseTime() {
            let csvRows = getCsvHeader(['type', 'range', 'count/value']);

            let statsToCsvRows = function (statsType) {
                let rows = [];

                let responseTimeHisto = statsManager.stats.getResponseTimeHisto(statsType);
                responseTimeHisto.forEach(item => {
                    rows.push([statsType, item.key, item.value].join());
                });

                return rows;
            }

            csvRows.push(...statsToCsvRows());
            csvRows.push(...statsToCsvRows(STATS_TYPE_PLAYLIST));
            csvRows.push(...statsToCsvRows(STATS_TYPE_CHUNKLIST));
            csvRows.push(...statsToCsvRows(STATS_TYPE_CHUNK));

            return csvRows.join('\n');
        }

        function csvAll(startTime, endTime) {
            let csvRows = getCsvHeader([
                'type', 'start', 'url',
                'status', 'timeout', 'error', 'size(byte)', 'time(ms)']);

            let statsToCsvRows = function (statsType) {
                let stats = statsManager.stats;

                stats.getTypedStatsItems(statsType).forEach(item => {
                    if (startTime && item.StartTime < startTime)
                        return;
                    if (endTime && item.StartTime >= endTime)
                        return;

                    csvRows.push([
                        item.statsType, (new Date(item.startTime)).toISOString(), item.url,
                        item.statusCode, item.timeout, item.error, item.size, item.responseTime].join());
                });
            }

            statsToCsvRows();
            //statsToCsvRows(STATS_TYPE_PLAYLIST);
            //statsToCsvRows(STATS_TYPE_CHUNKLIST);
            //statsToCsvRows(STATS_TYPE_CHUNK);

            return csvRows.join('\n');
        }

        function getReport() {
            let title = `Report on ${formatDateText(new Date())}`;
            let report = $('#stats')[0].outerHTML;

            let template = statsManager.reportTemplate || '<ht' + 'ml>' + '\n' +
                '<he' + 'ad>' + '\n' +
                '<me' + 'ta charset="utf-8" />' + '\n' +
                '<title>{title}</title>' + '\n' +
                '<li' + 'nk rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">' + '\n' +
                '<sc' + 'ript src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></sc' + 'ript>' + '\n' +
                '<style>' + '\n' +
                'th { background-color: darkgray; color: white; }' + '\n' +
                '</style>' + '\n' +
                '</h' + 'ead>' + '\n' +
                '<bo' + 'dy>' + '\n' +
                '    {report}' + '\n' +
                '</b' + 'ody>' + '\n' +
                '</h' + 'tml>';

            let full = template.replace('{title}', title).replace('{report}', report);
            return full;
        }

        function timestampDownload(date) {
            return formatDate(date, true, false);
        }

        function btnCsvStatusCode_onclick() {
            let csv = csvStatusCode();
            let filename = 'StatusCode-' + timestampDownload(new Date()) + '.csv';
            downloadCsv(csv, filename);
        }

        function btnCsvResponseTime_onclick() {
            let csv = csvResponseTime();
            let filename = 'ResponseTime-' + timestampDownload(new Date()) + '.csv';
            downloadCsv(csv, filename);
        }

        function btnCsvAll_onclick() {
            let csv = csvAll();
            let filename = 'All-' + timestampDownload(new Date()) + '.csv';
            downloadCsv(csv, filename);
        }

        function btnReport_onclick() {
            let report = getReport();
            let filename = 'Report-' + timestampDownload(new Date()) + '.html';
            downloadCsv(report, filename);
        }

        function uploadAzure(fileName, requestData) {
            let baseUrl = getSASUri();
            if (!baseUrl) {
                console.log("SAS URI is not set");
                return false;
            }

            let indexOfQueryStart = baseUrl.indexOf('?');
            let submitUri = baseUrl.substring(0, indexOfQueryStart) + '/' + fileName + baseUrl.substring(indexOfQueryStart);
            //console.log(submitUri);

            //let uri = submitUri + '&comp=block&blockid=' + blockIds[blockIds.length - 1];
            let uri = submitUri;

            $.ajax({
                url: uri,
                type: "PUT",
                data: requestData,
                processData: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('x-ms-blob-type', 'BlockBlob');
                    //xhr.setRequestHeader('Content-Length', requestData.length);
                },
                success: function (data, status) {
                    //console.log(data);
                    //console.log(status);
                    //bytesUploaded += requestData.length;
                    //let percentComplete = ((parseFloat(bytesUploaded) / parseFloat(selectedFile.size)) * 100).toFixed(2);
                    //$("#fileUploadProgress").text(percentComplete + " %");
                    //uploadFileInBlocks();                    
                },
                error: function (xhr, desc, err) {
                    console.log(desc);
                    console.log(err);
                }
            });

            return true;
        }

        function prefixUpload(date) {
            let user = $('#userID').val().trim() || 'anonym';
            return escapeFileName(user) + '/' + formatDate(date, false, false);
        }

        function timestampUpload(date) {
            return formatDate(date, true, true);
        }

        function uploadCsvStatusCode() {
            let csv = csvStatusCode();
            //let requestData = new Uint8Array(csv);
            let requestData = new TextEncoder().encode(csv);

            let now = new Date();
            let fileName = prefixUpload(now) + '/StatusCode-' + timestampUpload(now) + '.csv';
            uploadAzure(fileName, requestData);
        }

        function uploadCsvResponseTime() {
            let csv = csvResponseTime();
            //let requestData = new Uint8Array(csv);
            let requestData = new TextEncoder().encode(csv);

            let now = new Date();
            let fileName = prefixUpload(now) + '/ResponseTime-' + timestampUpload(now) + '.csv';
            uploadAzure(fileName, requestData);
        }

        function uploadCsvAll() {
            let csv = csvAll();
            //let requestData = new Uint8Array(csv);
            let requestData = new TextEncoder().encode(csv);

            let now = new Date();
            let fileName = prefixUpload(now) + '/All-' + timestampUpload(now) + '.csv';
            uploadAzure(fileName, requestData);
        }

        function uploadReport() {
            let report = getReport();
            let requestData = new TextEncoder().encode(report);

            let now = new Date();
            let fileName = prefixUpload(now) + '/Report-' + timestampUpload(now) + '.html';
            uploadAzure(fileName, requestData);
        }

        function btnUploadNow_onclick() {
            uploadCsvStatusCode();
            uploadCsvResponseTime();
            uploadCsvAll();
            uploadReport();
        }
    </script>
</head>

<body>
    <div id="settings" class="container pt-2">
        <Label>What's your name?</Label>
        <input type="text" class="form-control" id="userID" placeholder="Enter name">
        <label>What's your ISP? (Bell, Videotron etc)</label>
        <input type="text" class="form-control" id="isp" placeholder="Enter ISP">

        <div class="pt-2 row">
            <div class="col">
                <button id="btnStart" type="button" class="btn btn-primary" onclick="btnStart_onclick();">Start</button>
                <Label id="lblStartInfo" class="text-info align-middle h4 ml-2"></Label>
            </div>
            <div class="col-auto text-right">
                <button class="btn btn-outline-primary text-right" type="button" data-toggle="collapse"
                    data-target="#advanced" aria-expanded="false" aria-controls="advanced">
                    Advanced
                </button>
            </div>
        </div>

        <div id="advanced" class="contianer collapse bg-light border px-4 py-2 my-2">
            <div class="">
                <form>
                    <div class="form-group">
                        <label for="streamURLSelect">Stream URL:</label>
                        <select class="form-control" id="streamURLSelect">
                            <option>Random</option>
                        </select>
                    </div>

                    <div>
                        <Label>Show Stats Options:</Label>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkStatusCodeStats" checked
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkStatusCodeStats">
                                Show StatusCode stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkResponseTimeStats" checked
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkResponseTimeStats">
                                Show ResponseTime stats
                            </label>
                        </div>
                        <div class="form-check ml-4 pt-2">
                            <input class="form-check-input" type="checkbox" value="" id="chkOverallStats" checked
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkOverallStats">
                                Show Overall stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkPlaylistStats"
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkPlaylistStats">
                                Show Playlist stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkChunklistStats"
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkChunklistStats">
                                Show Chunklist stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkChunkStats"
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkChunkStats">
                                Show Chunk stats
                            </label>
                        </div>

                        <div class="ml-4">
                            <button id="btnClear" type="button" class="btn btn-outline-primary" onclick="clearStats();">
                                Reset Stats</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="py-1">
                <Label>Download the stats as CSV to local:</Label>
                <div class="ml-4">
                    <button id="btnCsvStatusCode" type="button" class="btn btn-outline-primary"
                        onclick="btnCsvStatusCode_onclick();">
                        Download CSV (StatusCode)</button>
                    <button id="btnCsvResponseTime" type="button" class="btn btn-outline-primary"
                        onclick="btnCsvResponseTime_onclick();">
                        Download CSV (ResponseTime)</button>
                    <button id="btnCsvAll" type="button" class="btn btn-outline-primary" onclick="btnCsvAll_onclick();">
                        Download CSV (All)</button>
                </div>
            </div>
            <div class="py-1">
                <Label>Download the report (HTML) to local:</Label>
                <div class="ml-4">
                    <button id="btnReport" type="button" class="btn btn-outline-primary" onclick="btnReport_onclick();">
                        Download report (HTML)</button>
                </div>
            </div>
            <div class="py-1">
                <Label>Upload the stats to the Azure stroage:</Label>
                <div class="form-check ml-4">
                    <input class="form-check-input" type="checkbox" id="autoUpload" checked>
                    <label class="form-check-label" for="autoUpload">
                        Upload to Azure storage every 5 minutes
                    </label>
                </div>
                <div class="ml-4">
                    <button id="btnUpload" type="button" class="btn btn-outline-primary"
                        onclick="btnUploadNow_onclick();">
                        Upload Now</button>
                </div>
            </div>
        </div>

        <hr>
    </div>

    <div id="stats" class="container py-2">
        <div id="divStatusCodeStats" class="d-block">
            <div><b>Status Code Stats (Overall)</b></div>
            <table id="tabStatusCodeStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats" class="d-block">
            <div><b>Response Time Stats (Overall)</b></div>
            <table id="tabResponseTimeStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divStatusCodeStats_Playlist" class="d-none">
            <div><b>Status Code Stats (Playlist)</b></div>
            <table id="tabStatusCodeStats_Playlist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats_Playlist" class="d-none">
            <div><b>Response Time Stats (Playlist)</b></div>
            <table id="tabResponseTimeStats_Playlist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divStatusCodeStats_Chunklist" class="d-none">
            <div><b>Status Code Stats (Chunklist)</b></div>
            <table id="tabStatusCodeStats_Chunklist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats_Chunklist" class="d-none">
            <div><b>Response Time Stats (Chunklist)</b></div>
            <table id="tabResponseTimeStats_Chunklist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divStatusCodeStats_Chunk" class="d-none">
            <div><b>Status Code Stats (Chunk)</b></div>
            <table id="tabStatusCodeStats_Chunk" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats_Chunk" class="d-none">
            <div><b>Response Time Stats (Chunk)</b></div>
            <table id="tabResponseTimeStats_Chunk" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divPlaylistStats" class="d-none">
            <div><b>Playlist Stats</b></div>
            <table id="tabPlaylistStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Name</th>
                        <th class="col-6">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divChunklistStats" class="d-none">
            <div><b>Chunklist Stats</b></div>
            <table id="tabChunklistStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Name</th>
                        <th class="col-6">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divChunkStats" class="d-none">
            <div><b>Chunk Stats</b></div>
            <table id="tabChunkStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Name</th>
                        <th class="col-6">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</body>

</html>