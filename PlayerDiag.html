<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>HLS Player Diagnostics</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" type="text/css" href="lib/bootstrap/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="PlayerDiag.css">

    <script src="lib/jquery/jquery.js"></script>
    <script src="lib/bootstrap/bootstrap.js"></script>
    <script src="PlayerDiagSetting.js"></script>

    <script>
        // http://www.jquerybyexample.net/2012/06/get-url-parameters-using-jquery.html
        function getURLParameter(sParam) {
            var sPageURL = decodeURIComponent(window.location.search.substring(1));
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        }
    </script>

    <script>
        "use strict";
        class StatsItem {
            constructor(startTime, url, statusCode, size, responseTime) {
                this.startTime = startTime;
                this.url = url;
                this.statusCode = statusCode;
                this.size = size;
                this.responseTime = responseTime;
            }
        }

        class Stats {
            constructor(id) {
                this.id = id;

                // array of StatsItem
                this.statsItems = [];
            }

            addStats(item) {
                this.statsItems.push(item);
                while (this.statsItems.length > 10000) {
                    this.statsItems.shift();
                }
            }

            lastURL() {
                if (this.statsItems && this.statsItems.length > 0) {
                    return this.statsItems[this.statsItems.length - 1].url;
                }
                return "";
            }

            getStatusCodes() {
                let statusCodes = {};

                let sequentialTimeout = 0;
                let curSequentialTimeout = 0;
                this.statsItems.forEach(item => {
                    curSequentialTimeout = (item.statusCode == 0 ? curSequentialTimeout + 1 : 0);
                    if (sequentialTimeout < curSequentialTimeout)
                        sequentialTimeout = curSequentialTimeout;
                });
                if (sequentialTimeout > 0) {
                    statusCodes['Sequential timeout'] = sequentialTimeout;
                }

                this.statsItems.forEach(item => {
                    let key = '' + item.statusCode; // convert to string
                    if (statusCodes[key]) {
                        statusCodes[key]++;
                    } else {
                        statusCodes[key] = 1;
                    }
                });

                return statusCodes;
            }

            responseTimeLast() {
                if (this.statsItems.length <= 0)
                    return 0;
                return this.statsItems[this.statsItems.length - 1].responseTime;
            }
            responseTimeMin() {
                //return Math.min.apply(Math, this.responseTimes);

                if (this.statsItems.length <= 0)
                    return 0;
                return this.statsItems.reduce((min, cur) => min < cur.responseTime ? min : cur.responseTime, this.statsItems[0].responseTime);
            }
            responseTimeMax() {
                //return Math.max.apply(Math, this.responseTimes);

                if (this.statsItems.length <= 0)
                    return 0;
                return this.statsItems.reduce((max, cur) => max > cur.responseTime ? max : cur.responseTime, this.statsItems[0].responseTime);
            }
            responseTimeAvg() {
                if (this.statsItems.length <= 0)
                    return 0;

                var sum = this.statsItems.reduce((total, cur) => total + cur.responseTime, 0);
                return Math.floor(sum / this.statsItems.length);
            }
            responseTimeAvgLast10() {
                if (this.statsItems.length <= 0)
                    return 0;

                var last10 = this.statsItems.slice(-10);
                var sum = last10.reduce((total, cur) => total + cur.responseTime, 0);
                return Math.floor(sum / last10.length);
            }
            responseTimeAvgLast100() {
                if (this.statsItems.length <= 0)
                    return 0;

                var last100 = this.statsItems.slice(-100);
                var sum = last100.reduce((total, cur) => total + cur.responseTime, 0);
                return Math.floor(sum / last100.length);
            }
        }

        var statsInfo = {
            startTime: 0,
            ipAddress: '',
            userAgent: '',
            reportTemplate: ''
        };
        var playlistStats = new Stats('#tabPlaylistStats tbody');
        var chunklistStats = new Stats('#tabChunklistStats tbody');
        var chunkStats = new Stats('#tabChunkStats tbody');
        var lastChunk;
        var playing = false;
    </script>

    <script>
        "use strict";
        function getChunk(url) {
            let startTime = (new Date()).getTime();

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    let endTime = (new Date()).getTime();
                    let responseTime = endTime - startTime;

                    let size = 0;
                    if (xhr.response && xhr.response.length)
                        size = xhr.response.length;
                    let item = new StatsItem(startTime, url, xhr.status, size, responseTime);
                    chunkStats.addStats(item);

                    displayResult(chunkStats, '#tabChunkStats tbody');
                }
            };
            xhr.open("GET", url, true);
            xhr.send();
        }

        function getChunklist(url) {
            let startTime = (new Date()).getTime();

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    let endTime = (new Date()).getTime();
                    let responseTime = endTime - startTime;

                    if (xhr.status == 200) {
                        var chunks = [];

                        var myRegexp = /#EXTINF.*\r?\n(.*)/g;
                        var m = myRegexp.exec(xhr.responseText);
                        while (m) {
                            if (m[1] && m[1].indexOf("#") == -1) { // not empty and not starts with #
                                chunks.push(m[1]);
                            }
                            m = myRegexp.exec(xhr.responseText);
                        }

                        if (chunks.length > 0) {
                            var lastChunkIndex = chunks.indexOf(lastChunk);

                            var playingChunk;
                            if (lastChunkIndex >= 0 && lastChunkIndex < chunks.length - 1) {
                                playingChunk = chunks[lastChunkIndex + 1];
                            } else {
                                playingChunk = chunks[chunks.length - 1];
                            }

                            if (playingChunk != lastChunk) {
                                lastChunk = playingChunk;

                                var pos = url.lastIndexOf("/");
                                var chunkUrl = url.substring(0, pos + 1) + lastChunk;
                                getChunk(chunkUrl);
                            }
                        }
                    }

                    let size = 0;
                    if (xhr.response && xhr.response.length)
                        size = xhr.response.length;
                    let item = new StatsItem(startTime, url, xhr.status, size, responseTime);
                    chunklistStats.addStats(item);

                    displayResult(chunklistStats, '#tabChunklistStats tbody');

                    if (playing) {
                        setTimeout(getChunklist, 8000, url);
                    }
                }
            };
            xhr.open("GET", url, true);
            xhr.send();
        }


        function getPlaylist(url) {
            let startTime = (new Date()).getTime();

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    let endTime = (new Date()).getTime();
                    let responseTime = endTime - startTime;

                    let hasChunklist = false;
                    if (xhr.status >= 200 && xhr.status < 400) {
                        var myRegexp = /#EXT-X-STREAM-INF.*\r?\n(.*)/;
                        var m = myRegexp.exec(xhr.responseText);
                        if (m && m[1]) {
                            var pos = url.lastIndexOf("/");
                            var chunklistUrl = (pos > 0 ? url.substring(0, pos + 1) + m[1] : m[1]);
                            getChunklist(chunklistUrl);
                            hasChunklist = true;
                        }
                    }


                    let size = 0;
                    if (xhr.response && xhr.response.length)
                        size = xhr.response.length;
                    let item = new StatsItem(startTime, url, xhr.status, size, responseTime);
                    playlistStats.addStats(item);

                    displayResult(playlistStats, '#tabPlaylistStats tbody');

                    if (playing && !hasChunklist) {
                        setTimeout(getChunklist, 1000, url);
                    }
                }
            };
            xhr.open("GET", url, true);
            xhr.send();
        }

        $(function () {
            // If your site is on Cloudflare, then you can use '/cdn-cgi/trace' instead
            $.get('https://www.cloudflare.com/cdn-cgi/trace', function (data) {
                //console.log(data)
                let lines = ('' + data).split(/\r*?\n/g);
                lines.forEach(line => {
                    if (line.startsWith('ip='))
                        statsInfo.ipAddress = line.substr(3);
                    else if (line.startsWith('uag='))
                        statsInfo.userAgent = line.substr(4);
                })
            })

            try {
                $.get('PlayerDiagReport.html', function (data) {
                    statsInfo.reportTemplate = '' + data;
                });
            } catch (err) {

            }

            setting.streamURLs.forEach(item => {
                $('#streamURLSelect').append($('<option></option>').val(item).text(item));
            });

            loadSettings();
            chkStats_onchange();

            clearStats();
            setInterval(myTimer, 1000);
        });

        $(window).on('unload', () => {
            saveSettings();
        })

        function saveSettings() {
            //console.log('saveSettings');
            let saveValue = function (name, id) {
                localStorage.setItem(name, $('#' + id).val());
            };
            let saveCheck = function (name, id) {
                localStorage.setItem(name, $('#' + id).prop('checked'));
            };

            try {
                saveValue('userid', 'userID');
                saveValue('isp', 'isp');
                saveValue('streamUrl', 'streamURLSelect');

                saveCheck('autoUpload', 'autoUpload');

                saveCheck('showStatusCodeStats', 'chkStatusCodeStats');
                saveCheck('showResponseTimeStats', 'chkResponseTimeStats');
                saveCheck('showOverallStats', 'chkOverallStats');
                saveCheck('showPlaylistStats', 'chkPlaylistStats');
                saveCheck('showChunklistStats', 'chkChunklistStats');
                saveCheck('showChunkStats', 'chkChunkStats');
            } catch {

            }
        }

        function loadSettings() {
            let loadValue = function (name, id) {
                let value = localStorage.getItem(name);
                if (value)
                    $('#' + id).val(value);
            };
            let loadOption = function (name, id) {
                let value = localStorage.getItem(name);
                if (value)
                    $('#' + id).find(`option[value="${value}"`).attr('selected', true);
            };
            let loadCheck = function (name, id) {
                let value = localStorage.getItem(name);
                if (value === 'true')
                    $('#' + id).prop('checked', true);
                else if (value === 'false')
                    $('#' + id).prop('checked', false);
            };

            try {
                loadValue("userid", 'userID');
                loadValue('isp', 'isp');
                loadOption('streamUrl', 'streamURLSelect');

                loadCheck('autoUpload', 'autoUpload');

                loadCheck('showStatusCodeStats', 'chkStatusCodeStats');
                loadCheck('showResponseTimeStats', 'chkResponseTimeStats');
                loadCheck('showOverallStats', 'chkOverallStats');
                loadCheck('showPlaylistStats', 'chkPlaylistStats');
                loadCheck('showChunklistStats', 'chkChunklistStats');
                loadCheck('showChunkStats', 'chkChunkStats');
            } catch {

            }
        }

        function chkStats_onchange() {
            let showStats = function (chkId1, chkId2, divId) {
                if ($('#' + chkId1).prop('checked') && $('#' + chkId2).prop('checked')) {
                    $('#' + divId).removeClass('d-none').addClass('d-block');
                } else {
                    $('#' + divId).removeClass('d-block').addClass('d-none');
                }
            }

            showStats('chkStatusCodeStats', 'chkOverallStats', 'divStatusCodeStats');
            showStats('chkResponseTimeStats', 'chkOverallStats', 'divResponseTimeStats');
            showStats('chkStatusCodeStats', 'chkPlaylistStats', 'divStatusCodeStats_Playlist');
            showStats('chkResponseTimeStats', 'chkPlaylistStats', 'divResponseTimeStats_Playlist');
            showStats('chkStatusCodeStats', 'chkChunklistStats', 'divStatusCodeStats_Chunklist');
            showStats('chkResponseTimeStats', 'chkChunklistStats', 'divResponseTimeStats_Chunklist');
            showStats('chkStatusCodeStats', 'chkChunkStats', 'divStatusCodeStats_Chunk');
            showStats('chkResponseTimeStats', 'chkChunkStats', 'divResponseTimeStats_Chunk');

            showStats('chkPlaylistStats', 'chkPlaylistStats', 'divPlaylistStats');
            showStats('chkChunklistStats', 'chkChunklistStats', 'divChunklistStats');
            showStats('chkChunkStats', 'chkChunkStats', 'divChunkStats');

        }

        var lastStartTime = 0;
        var lastUploadTime = 0;
        function myTimer() {
            saveSettings();

            if (playing) {
                let now = new Date().getTime();
                let elapsed = now - lastStartTime;
                $('#lblStartInfo').text('Testing in progress ' + formatDuration(elapsed));
            } else {
                $('#lblStartInfo').text('');
            }

            if (playing && $('#autoUpload').prop('checked')) {
                let timeAlign = 5 * 60 * 1000; // 5 minutes

                if (lastUploadTime < lastStartTime)
                    lastUploadTime = lastStartTime;
                let nextUploadTime = Math.ceil(lastUploadTime / timeAlign) * timeAlign + timeAlign;

                let now = new Date().getTime();
                if (now > nextUploadTime) {
                    /*let csv = csvAll(lastUploadTime, nextUploadTime);
                    //let requestData = new Uint8Array(csv);
                    let requestData = new TextEncoder().encode(csv);

                    let user = $('#userID').val() || 'user';
                    let fileName = 'auto_' + user + '_' + formatDate(nextUploadTime) + '.csv';

                    if (uploadAzure(fileName, requestData)) {
                        lastUploadTime = nextUploadTime;
                    }*/
                    btnUploadNow_onclick();
                    lastUploadTime = nextUploadTime;
                }
            }

        }

        function getStreamUrl() {
            let streamUrl = getURLParameter('streamurl') || $('#streamURLSelect').val();

            if (streamUrl === 'Random') {
                if (setting.streamURLs.length > 0) {
                    let index = Math.floor(Math.random() * setting.streamURLs.length);
                    streamUrl = setting.streamURLs[index];
                } else {
                    streamUrl = 'http://sg002-live.sliq.net/00309-live/matrix1/Playlist.m3u8';
                }
            }
            streamUrl = streamUrl || 'http://sg002-live.sliq.net/00309-live/matrix1/Playlist.m3u8';

            return streamUrl;
        }

        function getSASUri() {
            let sasUri = getURLParameter('sasuri') || '' + setting.sasURI;
            if (!sasUri.startsWith("http")) {
                sasUri = window.atob(sasUri);
            }
            return sasUri;
        }

        function btnStart_onclick() {
            saveSettings();


            var btnStart = $('#btnStart');

            if (btnStart.text() == 'Start') {
                let streamUrl = getStreamUrl();
                console.log('testing ' + streamUrl);

                getPlaylist(streamUrl);
                btnStart.text('Stop');
                playing = true;
                if (statsInfo.startTime == 0)
                    statsInfo.startTime = (new Date()).getTime();
                lastStartTime = (new Date()).getTime();
            } else {
                // todo: stop                
                btnStart.text('Start');
                playing = false;

                btnUploadNow_onclick();
            }
        }

    </script>

    <script>
        "use strict";
        function displayResult(stats, id) {
            var tbody = $(id).empty();
            var even = true;
            var addRow = function (name, value) {
                tbody.append(
                    $('<tr class="d-flex"></tr>')/*.addClass(even ? 'd0' : 'd1')*/.append(
                        '<td class="col-6">' + name + '</td>' +
                        '<td class="col-6">' + value + '</td>')
                );
                even = !even;
            }

            if (stats.lastURL()) {
                addRow("Last URL", stats.lastURL());
            }

            let statusCodes = stats.getStatusCodes();

            for (var key in statusCodes) {
                var value = statusCodes[key];
                addRow("StatusCode " + key, value);
            }

            if (stats.statsItems.length > 0) {
                addRow('Response Time Last (ms)', stats.responseTimeLast());
                addRow('Response Time Min (ms)', stats.responseTimeMin());
                addRow('Response Time Max (ms)', stats.responseTimeMax());
                addRow('Response Time Avg (ms)', stats.responseTimeAvg());
                addRow('Response Time Avg (Last 10) (ms)', stats.responseTimeAvgLast10());
                addRow('Response Time Avg (Last 100) (ms)', stats.responseTimeAvgLast100());
            }

            displayStatusCodeStats();
            displayResponseTimeStats();
        }

        function displayStatusCodeStats() {
            let statusCodes = {};
            let getCodes = function (stats) {
                stats.statsItems.forEach((item) => {
                    let key = '' + item.statusCode;
                    if (statusCodes[key]) {
                        statusCodes[key]++;
                    } else {
                        statusCodes[key] = 1;
                    }
                });
            }

            getCodes(playlistStats);
            getCodes(chunklistStats);
            getCodes(chunkStats);


            let statusCodes_Playlist = playlistStats.getStatusCodes();
            let statusCodes_Chunklist = chunklistStats.getStatusCodes();
            let statusCodes_Chunk = chunkStats.getStatusCodes();

            let displayCodes = (tbody, statusCodes) => {
                //var tbody = $('#tabStatusCodeStats tbody').empty();                
                var even = true;
                var addRow = function (name, value) {
                    tbody.append(
                        $('<tr class="d-flex"></tr>')/*.addClass(even ? 'd0' : 'd1')*/.append(
                            '<td class="col-6">' + name + '</td>' +
                            '<td class="col-6">' + value + '</td>')
                    );
                    even = !even;
                }

                for (var key in statusCodes) {
                    var value = statusCodes[key];
                    addRow(key, value);
                }
            }

            displayCodes($('#tabStatusCodeStats tbody').empty(), statusCodes);
            displayCodes($('#tabStatusCodeStats_Playlist tbody').empty(), statusCodes_Playlist);
            displayCodes($('#tabStatusCodeStats_Chunklist tbody').empty(), statusCodes_Chunklist);
            displayCodes($('#tabStatusCodeStats_Chunk tbody').empty(), statusCodes_Chunk);
        }


        function displayResponseTimeStats() {
            let getResponseTimeHisto = (statsArr) => {
                let ranges = [10, 100, 500, 1000, 2500, 5000, 10000];
                let responseTimeHisto = [
                    { key: "< 10ms", count: 0 },
                    { key: "10ms - 100ms", count: 0 },
                    { key: "100ms - 500ms", count: 0 },
                    { key: "500ms - 1s", count: 0 },
                    { key: "1s - 2.5s", count: 0 },
                    { key: "2.5s - 5s", count: 0 },
                    { key: "5s - 10s", count: 0 },
                    { key: "> 10s", count: 0 },
                ];

                let getHisto = (stats) => {
                    stats.statsItems.forEach(item => {
                        for (let i = 0; i < ranges.length; i++) {
                            if (item.responseTime < ranges[i]) {
                                responseTimeHisto[i].count++;
                                return;
                            }
                        }
                        // last
                        responseTimeHisto[responseTimeHisto.length - 1].count++;
                    })
                };

                if (Array.isArray(statsArr)) {
                    statsArr.forEach(stats => getHisto(stats));
                } else {
                    getHisto(statsArr);

                    responseTimeHisto.push({ key: 'Last (ms)', count: statsArr.responseTimeLast() });
                    responseTimeHisto.push({ key: 'Min (ms)', count: statsArr.responseTimeMin() });
                    responseTimeHisto.push({ key: 'Max (ms)', count: statsArr.responseTimeMax() });
                    responseTimeHisto.push({ key: 'Avg (ms)', count: statsArr.responseTimeAvg() });
                    responseTimeHisto.push({ key: 'Avg (Last 10) (ms)', count: statsArr.responseTimeAvgLast10() });
                    responseTimeHisto.push({ key: 'Avg (Last 100) (ms)', count: statsArr.responseTimeAvgLast100() });
                }

                return responseTimeHisto;
            }

            let playlistHisto = getResponseTimeHisto(playlistStats);
            let chunklistHisto = getResponseTimeHisto(chunklistStats);
            let chunkHisto = getResponseTimeHisto(chunkStats);
            let overallHisto = getResponseTimeHisto([playlistStats, chunklistStats, chunkStats]);

            let display = (tbody, responseTimeStats) => {
                //let tbody = $('#tabResponseTimeStats tbody').empty();
                let even = true;
                let addRow = function (name, value) {
                    tbody.append(
                        $('<tr class="d-flex"></tr>')/*.addClass(even ? 'd0' : 'd1')*/.append(
                            '<td class="col-6">' + name + '</td>' +
                            '<td class="col-6">' + value + '</td>')
                    );
                    even = !even;
                }

                responseTimeStats.forEach(item => {
                    addRow(item.key, item.count);
                });
            };

            display($('#tabResponseTimeStats tbody').empty(), overallHisto);
            display($('#tabResponseTimeStats_Playlist tbody').empty(), playlistHisto);
            display($('#tabResponseTimeStats_Chunklist tbody').empty(), chunklistHisto);
            display($('#tabResponseTimeStats_Chunk tbody').empty(), chunkHisto);
        }

        function clearStats() {
            statsInfo.startTime = playing ? statsInfo.startTime = (new Date()).getTime() : 0;

            playlistStats = new Stats();
            chunklistStats = new Stats();
            chunkStats = new Stats();
            lastChunk = void 0; // lastChunk is undefined

            displayStatusCodeStats();
            displayResponseTimeStats();

            displayResult(playlistStats, '#tabPlaylistStats tbody');
            displayResult(chunklistStats, '#tabChunklistStats tbody');
            displayResult(chunkStats, '#tabChunkStats tbody');
        }

        function downloadCsv(csv, filename) {
            //var blob = new Blob([new Uint8Array(bArr)], { type: 'text/csv;charset=UTF-16LE;' });
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-16;' });

            if (navigator.msSaveBlob) {
                navigator.msSaveBlob(blob, filename);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) {
                    var url = window.URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }
            }
        }

        function formatDuration(duration, milliPart) {
            let secs = Math.floor(duration / 1000);
            let hours = Math.floor(secs / (60 * 60));

            let divisor_for_minutes = secs % (60 * 60);
            let minutes = Math.floor(divisor_for_minutes / 60);

            let divisor_for_seconds = divisor_for_minutes % 60;
            let seconds = Math.ceil(divisor_for_seconds);

            let str = '' + hours + ':' + ('0' + minutes).slice(-2) + ':' + ('0' + seconds).slice(-2);
            if (milliPart) str += '.' + ('00' + duration % 1000).slice(-3);
            return str;
        }

        function formatDate(d) {
            if (typeof d === 'number') {
                d = new Date(d);
            }
            return d.getFullYear() +
                ('0' + (d.getMonth() + 1)).slice(-2) +
                ('0' + d.getDate()).slice(-2) + '_' +
                ('0' + d.getHours()).slice(-2) +
                ('0' + d.getMinutes()).slice(-2) +
                ('0' + d.getSeconds()).slice(-2);
        }

        function formatDateText(d) {
            if (typeof d === 'number') {
                d = new Date(d);
            }
            return d.getFullYear() + '-' +
                ('0' + (d.getMonth() + 1)).slice(-2) + '-' +
                ('0' + d.getDate()).slice(-2) + ' ' +
                ('0' + d.getHours()).slice(-2) + ':' +
                ('0' + d.getMinutes()).slice(-2) + ':' +
                ('0' + d.getSeconds()).slice(-2);
        }

        function escapeCSV(term) {
            let strTerm = '' + term; // convert to string
            if (strTerm.match(/,|"|\n/)) {
                let quoted = strTerm.replace(/"/g, '""');
                return '"' + quoted + '"';
            } else {
                return strTerm;
            }
        }

        function escapeFileName(fileName) {
            return fileName.replace(/[,\\\/:*?"<>|]/g, '_')
        }

        function getCsvHeader(headers) {
            let user = $('#userID').val().trim();
            let isp = $('#isp').val().trim();

            let line1 = [
                headers.join(),
                'user', 'isp', 'startTime', 'endTime', 'ipAddress', 'userAgent'
            ].join();
            let line2 = [
                ','.repeat(headers.length - 1),
                escapeCSV(user), escapeCSV(isp),
                statsInfo.startTime == 0 ? '' : new Date(statsInfo.startTime).toISOString(),
                statsInfo.startTime == 0 ? '' : new Date().toISOString(),
                statsInfo.ipAddress, escapeCSV(statsInfo.userAgent)
            ].join();
            return [line1, line2].join('\n');
        }

        function csvStatusCode() {
            //let csv = getCsvHeader(['type', 'statusCode', 'count']) + '\n';
            let csvRows = [getCsvHeader(['type', 'statusCode', 'count'])];

            let statsToCsvRows = function (stats, type) {
                let rows = [];

                let statusCodes = stats.getStatusCodes();
                for (var key in statusCodes) {
                    var value = statusCodes[key];
                    rows.push("" + type + "," + key + "," + value);
                }
                return rows;
            }

            csvRows.push(...statsToCsvRows(playlistStats, "playlist"));
            csvRows.push(...statsToCsvRows(chunklistStats, "chunklist"));
            csvRows.push(...statsToCsvRows(chunkStats, "chunk"));

            return csvRows.join('\n');
        }

        function csvResponseTime() {
            //let csv = getCsvHeader(['type', 'range', 'count']) + '\n';
            let csvRows = [getCsvHeader(['type', 'range', 'count'])];

            let statsToCsvRows = function (stats, type) {
                let getRow = (name, value) => {
                    return '' + type + ',' + name + ',' + value;
                }

                let rows = [];

                let i = 0;
                let ranges = [10, 100, 500, 1000, 2500, 5000, 10000];
                let counts = []; // ranges.length+1
                for (i = 0; i <= ranges.length; i++) {
                    counts[i] = 0;
                }

                stats.statsItems.forEach(item => {
                    for (let i = 0; i < ranges.length; i++) {
                        if (item.responseTime < ranges[i]) {
                            counts[i]++;
                            return;
                        }
                    }
                    // last
                    counts[counts.length - 1]++;
                })

                for (i = 0; i < ranges.length; i++) {
                    let prev = (i == 0 ? 0 : ranges[i - 1]);
                    rows.push(getRow(prev + '-' + ranges[i], counts[i]));
                }
                // last
                rows.push(getRow(">" + ranges[ranges.length - 1], counts[counts.length - 1]));


                rows.push(getRow('Last', stats.responseTimeLast()));
                rows.push(getRow('Min', stats.responseTimeMin()));
                rows.push(getRow('Max', stats.responseTimeMax()));
                rows.push(getRow('Avg', stats.responseTimeAvg()));
                rows.push(getRow('Avg (Last 10)', stats.responseTimeAvgLast10()));
                rows.push(getRow('Avg (Last 100)', stats.responseTimeAvgLast100()));

                return rows;
                //return rows.join('\n') + '\n';                
            }

            csvRows.push(...statsToCsvRows(playlistStats, "playlist"));
            csvRows.push(...statsToCsvRows(chunklistStats, "chunklist"));
            csvRows.push(...statsToCsvRows(chunkStats, "chunk"));

            return csvRows.join('\n');
        }

        function csvAll(startTime, endTime) {
            //let csv = getCsvHeader(['type', 'startTime', 'url', 'statusCode', 'size(byte)', 'responseTime(ms)']) + '\n';
            let csvRows = [getCsvHeader(['type', 'startTime', 'url', 'statusCode', 'size(byte)', 'responseTime(ms)'])];

            let statsToCsvRows = function (stats, type) {
                let rows = [];

                stats.statsItems.forEach(item => {
                    if (startTime && item.StartTime < startTime)
                        return;
                    if (endTime && item.StartTime >= endTime)
                        return;

                    rows.push([type, (new Date(item.startTime)).toISOString(), item.url, item.statusCode, item.size, item.responseTime].join());
                });

                return rows;
            }

            csvRows.push(...statsToCsvRows(playlistStats, "playlist"));
            csvRows.push(...statsToCsvRows(chunklistStats, "chunklist"));
            csvRows.push(...statsToCsvRows(chunkStats, "chunk"));

            return csvRows.join('\n');
        }

        function getReport() {
            let title = `Report on ${formatDateText(new Date())}`;
            let report = $('#stats')[0].outerHTML;

            let full = '';
            if (statsInfo.reportTemplate) {
                full = statsInfo.reportTemplate.replace('{title}', title).replace('{report}', report);
            } else {
                full = '<ht' + 'ml>' + '\n' +
                    '<he' + 'ad>' + '\n' +
                    '<me' + 'ta charset="utf-8" />' + '\n' +
                    `<title>${title}</title>` + '\n' +
                    '<li' + 'nk rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">' + '\n' +
                    '<sc' + 'ript src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></sc' + 'ript>' + '\n' +
                    '<style>' + '\n' +
                    'th { background-color: darkgray; color: white; }' + '\n' +
                    '</style>' + '\n' +
                    '</h' + 'ead>' + '\n' +
                    '<bo' + 'dy>' + '\n' +
                    `    ${report}` + '\n' +
                    '</b' + 'ody>' + '\n' +
                    '</h' + 'tml>';
            }
            return full;
        }

        function btnCsvStatusCode_onclick() {
            let csv = csvStatusCode();
            let filename = 'StatusCode-' + formatDate(new Date()) + '.csv';
            downloadCsv(csv, filename);
        }

        function btnCsvResponseTime_onclick() {
            let csv = csvResponseTime();
            let filename = 'ResponseTime-' + formatDate(new Date()) + '.csv';
            downloadCsv(csv, filename);
        }

        function btnCsvAll_onclick() {
            let csv = csvAll();
            let filename = 'All-' + formatDate(new Date()) + '.csv';
            downloadCsv(csv, filename);
        }

        function btnReport_onclick() {
            let report = getReport();
            let filename = 'Report-' + formatDate(new Date()) + '.html';
            downloadCsv(report, filename);
        }

        function uploadAzure(fileName, requestData) {
            let baseUrl = getSASUri();
            if (!baseUrl) {
                console.log("SAS URI is not set");
                return false;
            }

            let indexOfQueryStart = baseUrl.indexOf('?');
            let submitUri = baseUrl.substring(0, indexOfQueryStart) + '/' + fileName + baseUrl.substring(indexOfQueryStart);
            //console.log(submitUri);

            //var uri = submitUri + '&comp=block&blockid=' + blockIds[blockIds.length - 1];
            let uri = submitUri;

            $.ajax({
                url: uri,
                type: "PUT",
                data: requestData,
                processData: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('x-ms-blob-type', 'BlockBlob');
                    //xhr.setRequestHeader('Content-Length', requestData.length);
                },
                success: function (data, status) {
                    //console.log(data);
                    //console.log(status);
                    //bytesUploaded += requestData.length;
                    //var percentComplete = ((parseFloat(bytesUploaded) / parseFloat(selectedFile.size)) * 100).toFixed(2);
                    //$("#fileUploadProgress").text(percentComplete + " %");
                    //uploadFileInBlocks();                    
                },
                error: function (xhr, desc, err) {
                    console.log(desc);
                    console.log(err);
                }
            });

            return true;
        }

        function uploadCsvStatusCode() {
            let csv = csvStatusCode();
            //let requestData = new Uint8Array(csv);
            let requestData = new TextEncoder().encode(csv);

            let user = $('#userID').val().trim();
            let name = user || 'anonym';
            let fileName = escapeFileName(name) + '/StatusCode-' + formatDate(new Date()) + '.csv';
            uploadAzure(fileName, requestData);
        }

        function uploadCsvResponseTime() {
            let csv = csvResponseTime();
            //let requestData = new Uint8Array(csv);
            let requestData = new TextEncoder().encode(csv);

            let user = $('#userID').val().trim();
            let name = user || 'anonym';
            let fileName = escapeFileName(name) + '/ResponseTime-' + formatDate(new Date()) + '.csv';
            uploadAzure(fileName, requestData);
        }

        function uploadCsvAll() {
            let csv = csvAll();
            //let requestData = new Uint8Array(csv);
            let requestData = new TextEncoder().encode(csv);

            let user = $('#userID').val().trim();
            let name = user || 'anonym';
            let fileName = escapeFileName(name) + '/All-' + formatDate(new Date()) + '.csv';
            uploadAzure(fileName, requestData);
        }

        function uploadReport() {
            let report = getReport();
            let requestData = new TextEncoder().encode(report);

            let user = $('#userID').val().trim();
            let name = user || 'anonym';
            let fileName = escapeFileName(name) + '/Report-' + formatDate(new Date()) + '.html';
            uploadAzure(fileName, requestData);
        }

        function btnUploadNow_onclick() {
            uploadCsvStatusCode();
            uploadCsvResponseTime();
            uploadCsvAll();
            uploadReport();
        }
    </script>
</head>

<body>
    <div id="settings" class="container pt-2">
        <Label>What's your name?</Label>
        <input type="text" class="form-control" id="userID" placeholder="Enter name">
        <label>What's your ISP? (Bell, Videotron etc)</label>
        <input type="text" class="form-control" id="isp" placeholder="Enter ISP">

        <div class="pt-2 row">
            <div class="col">
                <button id="btnStart" type="button" class="btn btn-primary" onclick="btnStart_onclick();">Start</button>
                <Label id="lblStartInfo" class="text-info h4 ml-2"></Label>
            </div>
            <div class="col text-right">
                <button class="btn btn-primary text-right" type="button" data-toggle="collapse" data-target="#advanced"
                    aria-expanded="false" aria-controls="advanced">
                    Advanced
                </button>
            </div>
        </div>

        <div id="advanced" class="contianer collapse bg-light border px-4 py-2 my-2">
            <div class="">
                <form>
                    <div class="form-group">
                        <label for="streamURLSelect">Stream URL:</label>
                        <select class="form-control" id="streamURLSelect">
                            <option>Random</option>
                        </select>
                    </div>

                    <div>
                        <Label>Show Stats Options:</Label>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkStatusCodeStats" checked
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkStatusCodeStats">
                                Show StatusCode stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkResponseTimeStats" checked
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkResponseTimeStats">
                                Show ResponseTime stats
                            </label>
                        </div>
                        <div class="form-check ml-4 pt-2">
                            <input class="form-check-input" type="checkbox" value="" id="chkOverallStats" checked
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkOverallStats">
                                Show Overall stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkPlaylistStats"
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkPlaylistStats">
                                Show Playlist stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkChunklistStats"
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkChunklistStats">
                                Show Chunklist stats
                            </label>
                        </div>
                        <div class="form-check ml-4">
                            <input class="form-check-input" type="checkbox" value="" id="chkChunkStats"
                                onchange="chkStats_onchange(this);">
                            <label class="form-check-label" for="chkChunkStats">
                                Show Chunk stats
                            </label>
                        </div>

                        <div class="ml-4">
                            <button id="btnClear" type="button" class="btn btn-primary" onclick="clearStats();">
                                Reset Stats</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="py-1">
                <Label>Download the stats as CSV to local:</Label>
                <div class="ml-4">
                    <button id="btnCsvStatusCode" type="button" class="btn btn-primary"
                        onclick="btnCsvStatusCode_onclick();">
                        Download CSV (StatusCode)</button>
                    <button id="btnCsvResponseTime" type="button" class="btn btn-primary"
                        onclick="btnCsvResponseTime_onclick();">
                        Download CSV (ResponseTime)</button>
                    <button id="btnCsvAll" type="button" class="btn btn-primary" onclick="btnCsvAll_onclick();">
                        Download CSV (All)</button>
                </div>
            </div>
            <div class="py-1">
                <Label>Download the report (HTML) to local:</Label>
                <div class="ml-4">
                    <button id="btnReport" type="button" class="btn btn-primary" onclick="btnReport_onclick();">
                        Download report (HTML)</button>
                </div>
            </div>
            <div class="py-1">
                <Label>Upload the stats to the Azure stroage:</Label>
                <div class="form-check ml-4">
                    <input class="form-check-input" type="checkbox" id="autoUpload" checked>
                    <label class="form-check-label" for="autoUpload">
                        Upload to Azure storage every 5 minutes
                    </label>
                </div>
                <div class="ml-4">
                    <button id="btnUpload" type="button" class="btn btn-primary" onclick="btnUploadNow_onclick();">
                        Upload Now</button>
                </div>
            </div>
        </div>

        <hr>
    </div>

    <div id="stats" class="container py-2">
        <div id="divStatusCodeStats" class="d-block">
            <div><b>Status Code Stats (Overall)</b></div>
            <table id="tabStatusCodeStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats" class="d-block">
            <div><b>Response Time Stats (Overall)</b></div>
            <table id="tabResponseTimeStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divStatusCodeStats_Playlist" class="d-none">
            <div><b>Status Code Stats (Playlist)</b></div>
            <table id="tabStatusCodeStats_Playlist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats_Playlist" class="d-none">
            <div><b>Response Time Stats (Playlist)</b></div>
            <table id="tabResponseTimeStats_Playlist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divStatusCodeStats_Chunklist" class="d-none">
            <div><b>Status Code Stats (Chunklist)</b></div>
            <table id="tabStatusCodeStats_Chunklist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats_Chunklist" class="d-none">
            <div><b>Response Time Stats (Chunklist)</b></div>
            <table id="tabResponseTimeStats_Chunklist" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divStatusCodeStats_Chunk" class="d-none">
            <div><b>Status Code Stats (Chunk)</b></div>
            <table id="tabStatusCodeStats_Chunk" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">StatusCode</th>
                        <th class="col-6">Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divResponseTimeStats_Chunk" class="d-none">
            <div><b>Response Time Stats (Chunk)</b></div>
            <table id="tabResponseTimeStats_Chunk" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Range</th>
                        <th class="col-6">Count/Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divPlaylistStats" class="d-none">
            <div><b>Playlist Stats</b></div>
            <table id="tabPlaylistStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Name</th>
                        <th class="col-6">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divChunklistStats" class="d-none">
            <div><b>Chunklist Stats</b></div>
            <table id="tabChunklistStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Name</th>
                        <th class="col-6">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="divChunkStats" class="d-none">
            <div><b>Chunk Stats</b></div>
            <table id="tabChunkStats" class="table table-sm table-striped table-bordered">
                <thead class="">
                    <tr class="d-flex">
                        <th class="col-6">Name</th>
                        <th class="col-6">Value</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</body>

</html>